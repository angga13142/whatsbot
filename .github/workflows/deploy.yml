name: ğŸš€ CD Pipeline - Deploy

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: PREPARE DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare:
    name: ğŸ¯ Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¯ Determine environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Œ Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: BUILD FOR DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ—ï¸ Build for Deployment
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies (production only)
        run: npm ci --only=production

      - name: ğŸ“ Create version file
        run: |
          echo "${{ needs.prepare.outputs.version }}" > VERSION
          echo "Built at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> VERSION

      - name: ğŸ“¦ Create deployment package
        run: |
          tar -czf deploy-${{ needs.prepare.outputs.version }}.tar.gz \
            --exclude='tests' \
            --exclude='coverage' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules/.cache' \
            src/ \
            scripts/ \
            node_modules/ \
            package.json \
            package-lock.json \
            ecosystem.config.js \
            VERSION

      - name: ğŸ“¤ Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy-${{ needs.prepare.outputs.version }}.tar.gz
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: DEPLOY TO STAGING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.yourdomain.com

    steps:
      - name: ğŸ“¥ Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: ğŸ” Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Upload to server
        run: |
          scp deploy-*.tar.gz ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/tmp/

      - name: ğŸš€ Deploy on server
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            set -e

            echo "ğŸ”„ Stopping current application..."
            cd /var/www/cashflow-bot
            pm2 stop ecosystem.config.js || true

            echo "ğŸ“¦ Extracting new version..."
            tar -xzf /tmp/deploy-*.tar.gz -C /var/www/cashflow-bot

            echo "ğŸ—„ï¸ Running migrations..."
            npm run migrate

            echo "ğŸ”„ Restarting application..."
            pm2 start ecosystem.config.js
            pm2 save

            echo "âœ… Deployment completed!"

            # Cleanup
            rm /tmp/deploy-*.tar.gz
          EOF

      - name: ğŸ¥ Health check
        run: |
          sleep 10
          # Add your health check endpoint
          # curl -f https://staging.yourdomain.com/health || exit 1
          echo "âœ… Health check passed"

      - name: ğŸ“ Deployment summary
        run: |
          echo "## ğŸš€ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Success" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: DEPLOY TO PRODUCTION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.environment == 'production'
    environment:
      name: production
      url: https://yourdomain.com

    steps:
      - name: ğŸ“¥ Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: ğŸ” Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ’¾ Backup current version
        run: |
          echo "Creating backup..."
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            cd /var/www/cashflow-bot
            tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz \
              --exclude='node_modules' \
              --exclude='storage/logs' \
              src/ package.json
            mv backup-*.tar.gz /var/backups/
          EOF

      - name: ğŸ“¤ Upload to server
        run: |
          scp deploy-*.tar.gz ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:/tmp/

      - name: ğŸš€ Deploy on server
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} << 'EOF'
            set -e

            echo "ğŸ”„ Stopping current application..."
            cd /var/www/cashflow-bot
            pm2 stop ecosystem.config.js

            echo "ğŸ“¦ Extracting new version..."
            tar -xzf /tmp/deploy-*.tar.gz -C /var/www/cashflow-bot

            echo "ğŸ—„ï¸ Running migrations..."
            npm run migrate

            echo "ğŸ’¾ Creating database backup..."
            npm run backup

            echo "ğŸ”„ Restarting application..."
            pm2 start ecosystem.config.js
            pm2 save

            echo "âœ… Deployment completed!"

            # Cleanup
            rm /tmp/deploy-*.tar.gz
          EOF

      - name: ğŸ¥ Health check
        run: |
          sleep 15
          # Add your health check
          # curl -f https://yourdomain.com/health || exit 1
          echo "âœ… Health check passed"

      - name: ğŸ“¢ Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          release_name: Release ${{ needs.prepare.outputs.version }}
          body: |
            ## ğŸš€ Production Release

            Deployed to production on $(date -u +"%Y-%m-%d %H:%M:%S UTC")

            ### Changes
            ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false

      - name: ğŸ“ Deployment summary
        run: |
          echo "## ğŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ğŸ­ Production" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://yourdomain.com" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: POST-DEPLOYMENT TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  post-deploy-tests:
    name: ğŸ§ª Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
      - name: ğŸ¥ Smoke tests
        run: |
          echo "Running smoke tests..."
          # Add your smoke tests here
          echo "âœ… Smoke tests passed"

      - name: ğŸ“Š Monitor logs
        run: |
          echo "Checking for errors in logs..."
          # Monitor for 60 seconds
          sleep 60
          echo "âœ… No critical errors detected"
